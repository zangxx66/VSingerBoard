import{E as e,y as a,l as t,m as s,g as l,b as n,c as o,d as r,e as i,z as u,f as d,i as m,A as c,B as g,u as p,n as f,o as _,C as h,v as y}from"./vendor-element-plus-BNN58Tgt.js";import{t as v,g as b,a as w}from"./times-X7rBhlB4.js";import{bc as x,u as k,n as V,r as j,ba as P,a1 as C,c as q,bd as z,V as D,q as M,D as B,t as E,L,E as U,x as Y,K as $,ao as F,a as H,I as K,y as T,G as I,J as N}from"./vendor-libs-DLrArELd.js";import{g as R}from"./request-BRje5s3q.js";import{p as A}from"./tool-7CWFlNCe.js";import{e as G}from"./excel-g-lxlBLo.js";import{b as J}from"./route-block-B_A1xBdJ.js";import"./vendor-vue-D3OeNkI5.js";import"./vendor-exceljs-C-8i3j8b.js";const O=["src","alt"],S={tag:"span",class:"chat-tag"},X={style:{width:"15%"}},Q={style:{display:"flex","text-align":"right"}},W=V({name:"history",__name:"index",setup(V){const J=j(!1),W=j(0),Z=j(),ee=P("historyDataCard"),ae=j(),te=j("0px"),se=C({uname:"",song_name:"",source:"all",start_time:0,end_time:0,size:20}),le=[{key:"全部",value:"all"},{key:"抖音",value:"douyin"},{key:"B站",value:"bilibili"}],ne=[{header:"日期",key:"date",width:50},{header:"昵称",key:"uname",width:50},{header:"歌名",key:"song",width:50},{header:"平台",key:"source",width:50}],oe=e=>{if(!e)return se.start_time=0,void(se.end_time=0);se.start_time=e[0],se.end_time=w(e[1])},{data:re,refetch:ie,fetchNextPage:ue,isFetching:de}=(me=se,x({queryKey:[R.name,me],queryFn:async a=>{const t=await R({...a.queryKey[1],page:a.pageParam});return 0!=t.code?(e.warning(t.msg||"请求失败"),{total:0,rows:[]}):{total:t.data.total,rows:t.data.rows}},getNextPageParam:(e,a)=>{const t=k(k(me).size)??20;return e.total>=t?a.length+1:void 0},staleTime:1e4,initialPageParam:1}));var me;const ce=q(()=>re.value?.pages.flatMap(e=>(W.value=e.total,e.rows)).map(e=>{const a={msg_id:e.id,uid:e.uid,uname:e.uname,msg:e.song_name,send_time:e.create_time,source:e.source,medal_name:"",medal_level:0,guard_level:0},t=A([a]);return{...e,song_name:t[0].html||e.song_name,create_time_str:v(e.create_time)}}).filter(Boolean)),ge=()=>{const e={};Object.assign(e,se),e.page=1,e.size=W.value,J.value=!0,pe.mutate(e)},pe=z({mutationFn:async e=>await R(e),onSuccess:a=>{if(0!=a.code)e.warning(a.msg||"请求失败");else{const e=a.data.rows.map(e=>({date:v(e.create_time),uname:e.uname,song:e.song_name,source:"bilibili"==e.source?"B站":"抖音"})),t=`点歌历史记录_${b()}`;G(ne,e,t)}J.value=!1},onError:a=>{e.error(a.message)}}),fe=e=>{"bottom"===e&&ce.value&&ce.value.length<W.value&&ue()};return D(()=>{const e=.9*window.innerHeight;ee.value?.$el.style.setProperty("overflow","hidden");const a=.6*e;te.value=`${a}px`}),(e,v)=>{const b=o,w=n,x=i,V=r,j=u,P=m,C=d,q=l,z=s,D=g,R=_,A=h,G=f,W=t,ee=a,ne=y;return E(),M(ee,{class:"history-container"},{default:B(()=>[L(W,{class:"history-main"},{default:B(()=>[L(z,{class:"history-card"},{header:B(()=>[...v[5]||(v[5]=[T("div",{class:"card-header"},[T("span",null,"查询")],-1)])]),default:B(()=>[L(q,{model:k(se),"label-width":"auto",inline:"",class:"inline-form"},{default:B(()=>[L(w,{label:"歌名",prop:"song_name"},{default:B(()=>[L(b,{modelValue:k(se).song_name,"onUpdate:modelValue":v[0]||(v[0]=e=>k(se).song_name=e),type:"text"},null,8,["modelValue"])]),_:1}),L(w,{label:"昵称",prop:"uname"},{default:B(()=>[L(b,{modelValue:k(se).uname,"onUpdate:modelValue":v[1]||(v[1]=e=>k(se).uname=e),type:"text"},null,8,["modelValue"])]),_:1}),L(w,{label:"点歌平台",prop:"source"},{default:B(()=>[L(V,{modelValue:k(se).source,"onUpdate:modelValue":v[2]||(v[2]=e=>k(se).source=e),placeholder:"请选择点歌平台"},{default:B(()=>[(E(),Y($,null,F(le,(e,a)=>L(x,{key:a,label:e.key,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),L(w,{label:"时间范围",prop:"dateRange",style:{width:"350px"}},{default:B(()=>[L(j,{modelValue:k(Z),"onUpdate:modelValue":v[3]||(v[3]=e=>H(Z)?Z.value=e:null),type:"daterange","value-format":"X",format:"YYYY-MM-DD",onChange:oe},null,8,["modelValue"])]),_:1}),L(w,null,{default:B(()=>[L(C,{type:"primary",onClick:v[4]||(v[4]=e=>k(ie)())},{default:B(()=>[L(P,{class:"el-icon--left"},{default:B(()=>[L(k(c))]),_:1}),v[6]||(v[6]=K(" 搜索 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),L(D),U((E(),M(z,{ref:"historyDataCard",class:"history-data-card"},{default:B(()=>[L(G,{ref_key:"chatInfiniteList",ref:ae,class:"chat-infinite-list",noresize:"",height:k(te),onEndReached:fe},{default:B(()=>[(E(!0),Y($,null,F(k(ce),(e,a)=>(E(),Y("div",{key:a,class:"chat-infinite-list-item"},[T("img",{src:`/images/${e.source}.png`,class:"source-img",alt:e.source,width:"24"},null,8,O),T("text",S,[K(N(e.uname)+"：",1),L(R,{style:{display:"flex"},innerHTML:e.song_name},null,8,["innerHTML"])]),T("span",X,N(e.create_time_str),1)]))),128)),0==k(ce)?.length?(E(),M(A,{key:0,description:"没有数据"})):I("",!0)]),_:1},8,["height"])]),footer:B(()=>[T("div",Q,[L(C,{type:"success",disabled:0==k(ce)?.length,loading:k(J),onClick:ge},{default:B(()=>[v[7]||(v[7]=K(" 导出历史记录 ",-1)),L(P,{class:"el-icon--right"},{default:B(()=>[L(k(p))]),_:1})]),_:1},8,["disabled","loading"])])]),_:1})),[[ne,k(de)]])]),_:1})]),_:1})}}});"function"==typeof J&&J(W);export{W as default};
