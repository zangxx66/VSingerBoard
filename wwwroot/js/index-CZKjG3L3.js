import{E as e,z as a,m as t,n as l,h as s,c as n,d as o,e as i,f as r,A as d,g as u,i as m,B as c,C as p,x as g,o as _,p as h,D as f,v as y}from"./vendor-element-plus-CjYS7DoP.js";import{t as v,a as b,g as w}from"./times-CDnvQ87d.js";import{r as x,p as k}from"./api-BnBC17YJ.js";import{bc as V,u as j,o as P,r as C,bb as H,a2 as L,c as M,W as z,t as D,E as B,v as U,M as Y,F as $,y as q,L as E,ap as F,b as K,J as T,z as N,H as R,K as A}from"./vendor-libs-Kq5ll9xE.js";import{e as I}from"./excel-CH2sLU4d.js";import"./vendor-vue-QPsD10U7.js";import"./vendor-exceljs-C-8i3j8b.js";const J={class:"chat-infinite-list-item"},W=["src","alt"],X={tag:"span",class:"chat-tag"},G={style:{width:"15%"}},O={style:{display:"flex","text-align":"right"}},Q=P({name:"history",__name:"index",setup(P){const Q=C(!1),S=C(0),Z=C(),ee=H("historyDataCard"),ae=C(),te=C("0px"),le=L({uname:"",song_name:"",source:"all",start_time:0,end_time:0,size:20}),se=[{key:"全部",value:"all"},{key:"抖音",value:"douyin"},{key:"B站",value:"bilibili"}],ne=e=>{if(!e)return le.start_time=0,void(le.end_time=0);le.start_time=e[0],le.end_time=b(e[1])},{data:oe,refetch:ie,fetchNextPage:re,isFetching:de}=(ue=le,V({queryKey:[x.getHistoryList.name,ue],queryFn:async a=>{const t=await x.getHistoryList({...a.queryKey[1],page:a.pageParam});return 0!=t.code?(e.warning(t.msg||"请求失败"),{total:0,rows:[]}):{total:t.data.total,rows:t.data.rows}},getNextPageParam:(e,a)=>{const t=j(j(ue).size)??20;return e.total>=t?a.length+1:void 0},staleTime:1e4,initialPageParam:1}));var ue;const me=M(()=>oe.value?.pages.flatMap(e=>(S.value=e.total,e.rows)).map(e=>{const a={msg_id:e.id,uid:e.uid,uname:e.uname,msg:e.song_name,send_time:e.create_time,source:e.source,medal_name:"",medal_level:0,guard_level:0},t=k([a]);return{...e,song_name:t[0].html||e.song_name,create_time_str:v(e.create_time)}}).filter(Boolean)),ce=()=>{Q.value=!0;const e=me.value?.map(e=>({date:v(e.create_time),uname:e.uname,song:e.song_name,source:"bilibili"==e.source?"B站":"抖音"})),a=`点歌历史记录_${w()}`;I([{header:"日期",key:"date",width:50},{header:"昵称",key:"uname",width:50},{header:"歌名",key:"song",width:50},{header:"平台",key:"source",width:50}],e,a),Q.value=!1},pe=e=>{"bottom"===e&&me.value&&me.value.length<S.value&&re()};return z(()=>{const e=.9*window.innerHeight;ee.value?.$el.style.setProperty("overflow","hidden");const a=.6*e;te.value=`${a}px`}),(e,v)=>{const b=o,w=n,x=r,k=i,V=d,P=m,C=u,H=s,L=l,M=p,z=h,I=f,S=_,ee=t,oe=a,re=y;return U(),D(oe,{class:"history-container"},{default:B(()=>[Y(ee,{class:"history-main"},{default:B(()=>[Y(L,{class:"history-card"},{header:B(()=>[...v[5]||(v[5]=[N("div",{class:"card-header"},[N("span",null,"查询")],-1)])]),default:B(()=>[Y(H,{model:j(le),"label-width":"auto",inline:"",class:"inline-form"},{default:B(()=>[Y(w,{label:"歌名",prop:"song_name"},{default:B(()=>[Y(b,{modelValue:j(le).song_name,"onUpdate:modelValue":v[0]||(v[0]=e=>j(le).song_name=e),type:"text"},null,8,["modelValue"])]),_:1}),Y(w,{label:"昵称",prop:"uname"},{default:B(()=>[Y(b,{modelValue:j(le).uname,"onUpdate:modelValue":v[1]||(v[1]=e=>j(le).uname=e),type:"text"},null,8,["modelValue"])]),_:1}),Y(w,{label:"点歌平台",prop:"source"},{default:B(()=>[Y(k,{modelValue:j(le).source,"onUpdate:modelValue":v[2]||(v[2]=e=>j(le).source=e),placeholder:"请选择点歌平台"},{default:B(()=>[(U(),q(E,null,F(se,e=>Y(x,{label:e.key,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),Y(w,{label:"时间范围",prop:"dateRange",style:{width:"350px"}},{default:B(()=>[Y(V,{modelValue:j(Z),"onUpdate:modelValue":v[3]||(v[3]=e=>K(Z)?Z.value=e:null),type:"daterange","value-format":"X",format:"YYYY-MM-DD",onChange:ne},null,8,["modelValue"])]),_:1}),Y(w,null,{default:B(()=>[Y(C,{type:"primary",onClick:v[4]||(v[4]=e=>j(ie)())},{default:B(()=>[Y(P,{class:"el-icon--left"},{default:B(()=>[Y(j(c))]),_:1}),v[6]||(v[6]=T(" 搜索 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),Y(M),$((U(),D(L,{class:"history-data-card",ref:"historyDataCard"},{default:B(()=>[Y(S,{class:"chat-infinite-list",noresize:"",height:j(te),onEndReached:pe,ref_key:"chatInfiniteList",ref:ae},{default:B(()=>[(U(!0),q(E,null,F(j(me),e=>(U(),q("div",J,[N("img",{src:`/images/${e.source}.png`,class:"source-img",alt:e.source,width:"24"},null,8,W),N("text",X,[T(A(e.uname)+"：",1),Y(z,{style:{display:"flex"},innerHTML:e.song_name},null,8,["innerHTML"])]),N("span",G,A(e.create_time_str),1)]))),256)),0==j(me)?.length?(U(),D(I,{key:0,description:"没有数据"})):R("",!0)]),_:1},8,["height"])]),footer:B(()=>[N("div",O,[Y(C,{type:"success",disabled:0==j(me)?.length,onClick:ce,loading:j(Q)},{default:B(()=>[v[7]||(v[7]=T(" 导出历史记录 ",-1)),Y(P,{class:"el-icon--right"},{default:B(()=>[Y(j(g))]),_:1})]),_:1},8,["disabled","loading"])])]),_:1})),[[re,j(de)]])]),_:1})]),_:1})}}});export{Q as default};
