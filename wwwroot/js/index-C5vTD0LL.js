import{E as e,l as a,m as t,g as s,b as l,c as n,d as o,e as r,A as i,f as u,i as d,B as m,C as c,x as g,n as p,o as f,D as _,s as h,v as y,y as v}from"./vendor-element-plus-HZbGYrKl.js";import{t as b,g as w,a as x}from"./times-Cw5rdMqO.js";import{bc as k,u as V,n as j,r as P,ba as C,a1 as D,c as q,bd as M,V as z,q as B,t as E,D as L,L as U,E as Y,x as $,K as F,ao as H,a as K,I as T,y as I,G as N,J as R}from"./vendor-libs-7289s0cb.js";import{g as A}from"./request-BsWu63JD.js";import{p as G}from"./tool-uNj5llJ9.js";import{e as J}from"./excel-g-lxlBLo.js";import{b as O}from"./route-block-B_A1xBdJ.js";import"./vendor-vue-Cl2YAQzn.js";import"./vendor-exceljs-C-8i3j8b.js";const S=["src","alt"],X={tag:"span",class:"chat-tag"},Q={class:"w-[15%]"},W={class:"flex text-align-right"},Z=j({name:"history",__name:"index",setup(j){const O=P(!1),Z=P(0),ee=P(),ae=C("historyDataCard"),te=P(),se=P("0px"),le=D({uname:"",song_name:"",source:"all",start_time:0,end_time:0,size:20}),ne=[{key:"全部",value:"all"},{key:"抖音",value:"douyin"},{key:"B站",value:"bilibili"}],oe=[{header:"日期",key:"date",width:50},{header:"昵称",key:"uname",width:50},{header:"歌名",key:"song",width:50},{header:"平台",key:"source",width:50}],re=e=>{if(!e)return le.start_time=0,void(le.end_time=0);le.start_time=e[0],le.end_time=x(e[1])},{data:ie,refetch:ue,fetchNextPage:de,isFetching:me}=(ce=le,k({queryKey:[A.name,ce],queryFn:async a=>{const t=await A({...a.queryKey[1],page:a.pageParam});return 0!=t.code?(e.warning(t.msg||"请求失败"),{total:0,rows:[]}):{total:t.data.total,rows:t.data.rows}},getNextPageParam:(e,a)=>{const t=V(V(ce).size)??20;return e.total>=t?a.length+1:void 0},staleTime:1e4,initialPageParam:1}));var ce;const ge=q(()=>ie.value?.pages.flatMap(e=>(Z.value=e.total,e.rows)).map(e=>{const a={msg_id:e.id,uid:e.uid,uname:e.uname,msg:e.song_name,send_time:e.create_time,source:e.source,medal_name:"",medal_level:0,guard_level:0},t=G([a]);return{...e,song_name:t[0].html||e.song_name,create_time_str:b(e.create_time)}}).filter(Boolean)),pe=()=>{const e={};Object.assign(e,le),e.page=1,e.size=Z.value,O.value=!0,fe.mutate(e)},fe=M({mutationFn:async e=>await A(e),onSuccess:a=>{if(0!=a.code)e.warning(a.msg||"请求失败");else{const e=a.data.rows.map(e=>({date:b(e.create_time),uname:e.uname,song:e.song_name,source:"bilibili"==e.source?"B站":"抖音"})),t=`点歌历史记录_${w()}`;J(oe,e,t)}O.value=!1},onError:a=>{e.error(a.message)}}),_e=e=>{"bottom"===e&&ge.value&&ge.value.length<Z.value&&de()};return z(()=>{const e=.9*window.innerHeight;ae.value?.$el.style.setProperty("overflow","hidden");const a=.6*e;se.value=`${a}px`}),(e,b)=>{const w=n,x=l,k=r,j=o,P=i,C=d,D=u,q=s,M=t,z=c,A=f,G=_,J=h,Z=p,ae=a,oe=v,ie=y;return E(),B(oe,{class:"history-container"},{default:L(()=>[U(ae,{class:"history-main"},{default:L(()=>[U(M,{class:"history-card"},{header:L(()=>[...b[5]||(b[5]=[I("div",{class:"card-header"},[I("span",null,"查询")],-1)])]),default:L(()=>[U(q,{model:V(le),"label-width":"auto",inline:"",class:"inline-form"},{default:L(()=>[U(x,{label:"歌名",prop:"song_name"},{default:L(()=>[U(w,{modelValue:V(le).song_name,"onUpdate:modelValue":b[0]||(b[0]=e=>V(le).song_name=e),type:"text"},null,8,["modelValue"])]),_:1}),U(x,{label:"昵称",prop:"uname"},{default:L(()=>[U(w,{modelValue:V(le).uname,"onUpdate:modelValue":b[1]||(b[1]=e=>V(le).uname=e),type:"text"},null,8,["modelValue"])]),_:1}),U(x,{label:"点歌平台",prop:"source"},{default:L(()=>[U(j,{modelValue:V(le).source,"onUpdate:modelValue":b[2]||(b[2]=e=>V(le).source=e),placeholder:"请选择点歌平台"},{default:L(()=>[(E(),$(F,null,H(ne,(e,a)=>U(k,{key:a,label:e.key,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),U(x,{label:"时间范围",prop:"dateRange",class:"w-[350px]"},{default:L(()=>[U(P,{modelValue:V(ee),"onUpdate:modelValue":b[3]||(b[3]=e=>K(ee)?ee.value=e:null),type:"daterange","value-format":"X",format:"YYYY-MM-DD",onChange:re},null,8,["modelValue"])]),_:1}),U(x,null,{default:L(()=>[U(D,{type:"primary",onClick:b[4]||(b[4]=e=>V(ue)())},{default:L(()=>[U(C,{class:"el-icon--left"},{default:L(()=>[U(V(m))]),_:1}),b[6]||(b[6]=T(" 搜索 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),U(z),Y((E(),B(M,{ref:"historyDataCard",class:"history-data-card"},{default:L(()=>[U(Z,{ref_key:"chatInfiniteList",ref:te,class:"chat-infinite-list",noresize:"",height:V(se),onEndReached:_e},{default:L(()=>[(E(!0),$(F,null,H(V(ge),(e,a)=>(E(),$("div",{key:a,class:"chat-infinite-list-item"},[I("img",{src:`/images/${e.source}.png`,class:"source-img",alt:e.source,width:"24"},null,8,S),I("text",X,[T(R(e.uname)+"：",1),U(A,{class:"flex",innerHTML:e.song_name},null,8,["innerHTML"])]),I("span",Q,R(e.create_time_str),1)]))),128)),0==V(ge)?.length?(E(),B(G,{key:0,description:"没有数据"})):N("",!0),U(J,{right:100,bottom:100,target:".chat-infinite-list > div"})]),_:1},8,["height"])]),footer:L(()=>[I("div",W,[U(D,{type:"success",disabled:0==V(ge)?.length,loading:V(O),onClick:pe},{default:L(()=>[b[7]||(b[7]=T(" 导出历史记录 ",-1)),U(C,{class:"el-icon--right"},{default:L(()=>[U(V(g))]),_:1})]),_:1},8,["disabled","loading"])])]),_:1})),[[ie,V(me)]])]),_:1})]),_:1})}}});"function"==typeof O&&O(Z);export{Z as default};
