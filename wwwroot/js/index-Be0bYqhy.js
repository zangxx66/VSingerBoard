import{E as e,b as a,c as t,d as l,F as s,G as i,H as n,g as o,h as r,z as d,m as u,n as c,i as g,B as p,C as m,I as y,J as _,x as f,K as h,L as w,v,t as k,u as x,y as b}from"./vendor-element-plus-CjYS7DoP.js";import{r as V}from"./api-BnBC17YJ.js";import{o as C,r as P,a2 as S,bd as j,t as U,v as D,u as K,b as L,E as F,M as E,H as z,J as B,bc as R,be as q,bb as H,c as I,W as M,z as O,F as T,L as $}from"./vendor-libs-Kq5ll9xE.js";import{g as J}from"./times-CDnvQ87d.js";import{i as N,e as G}from"./excel-CH2sLU4d.js";import"./vendor-vue-QPsD10U7.js";import"./vendor-exceljs-C-8i3j8b.js";const Q=C({__name:"add-playlist-dialog",emits:["submit"],setup(d,{expose:u,emit:c}){const g=c,p=P(!1),m=P(!1),y=S({id:0,song_name:"",singer:"",is_sc:!1,sc_price:0,language:"",tag:"",create_time:0}),_=()=>{p.value=!1,y.id=0,y.song_name="",y.singer="",y.is_sc=!1,y.sc_price=0,y.language="",y.tag=""},f=j({mutationFn:async e=>await V.addOrUpdatePlaylist({data:e}),onSuccess:a=>{if(m.value=!1,0!=a.code)e.warning(a.msg);else{const e={id:a.data,song_name:y.song_name,singer:y.singer,is_sc:y.is_sc,sc_price:y.sc_price,language:y.language,tag:y.tag,create_time:y.create_time};h(e)}}}),h=e=>{g("submit",e),_()};return u({openDialog:e=>{e&&Object.assign(y,e),p.value=!0}}),(d,u)=>{const c=l,g=t,h=i,w=s,v=n,k=o,x=r,b=a;return D(),U(b,{modelValue:K(p),"onUpdate:modelValue":u[8]||(u[8]=e=>L(p)?p.value=e:null),title:"新增歌曲",width:"450","destroy-on-close":"","before-close":_},{default:F(()=>[E(x,{model:K(y),"label-width":"auto"},{default:F(()=>[E(g,{label:"歌名",prop:"song_name"},{default:F(()=>[E(c,{modelValue:K(y).song_name,"onUpdate:modelValue":u[0]||(u[0]=e=>K(y).song_name=e),type:"text"},null,8,["modelValue"])]),_:1}),E(g,{label:"歌手",prop:"singer"},{default:F(()=>[E(c,{modelValue:K(y).singer,"onUpdate:modelValue":u[1]||(u[1]=e=>K(y).singer=e),type:"text"},null,8,["modelValue"])]),_:1}),E(g,{label:"语种",prop:"language"},{default:F(()=>[E(c,{modelValue:K(y).language,"onUpdate:modelValue":u[2]||(u[2]=e=>K(y).language=e),type:"text"},null,8,["modelValue"])]),_:1}),E(g,{label:"标签",prop:"tag"},{default:F(()=>[E(c,{modelValue:K(y).tag,"onUpdate:modelValue":u[3]||(u[3]=e=>K(y).tag=e),type:"text"},null,8,["modelValue"])]),_:1}),E(g,{label:"是否SC歌曲",prop:"is_sc"},{default:F(()=>[E(w,{modelValue:K(y).is_sc,"onUpdate:modelValue":u[4]||(u[4]=e=>K(y).is_sc=e)},{default:F(()=>[E(h,{value:!0},{default:F(()=>[...u[9]||(u[9]=[B("是",-1)])]),_:1}),E(h,{value:!1},{default:F(()=>[...u[10]||(u[10]=[B("否",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),K(y).is_sc?(D(),U(g,{key:0,label:"SC价格",prop:"sc_price"},{default:F(()=>[E(v,{modelValue:K(y).sc_price,"onUpdate:modelValue":u[5]||(u[5]=e=>K(y).sc_price=e),min:30,controls:!1},null,8,["modelValue"])]),_:1})):z("",!0),E(g,null,{default:F(()=>[E(k,{loading:K(m),type:"primary",onClick:u[6]||(u[6]=a=>{y.song_name?y.singer?!y.is_sc||y.sc_price?(m.value=!0,y.create_time=J(),f.mutate(y)):e.warning("请输入SC价格"):e.warning("请输入歌手"):e.warning("请输入歌名")})},{default:F(()=>[...u[11]||(u[11]=[B("保存",-1)])]),_:1},8,["loading"]),E(k,{onClick:u[7]||(u[7]=e=>_())},{default:F(()=>[...u[12]||(u[12]=[B("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),W={style:{height:"40px",display:"flex"}},A={style:{display:"flex"}},X={style:{width:"100%","flex-direction":"row-reverse",display:"flex",gap:"10px"}},Y=C({name:"playlist",__name:"index",setup(a){const s=q(),i=P(!1),n=P(!1),C=P(0),L=H("playlistDataCard"),z=H("playlistInfiniteList"),Y=H("addPlaylistDialogRef"),Z=S({keyword:"",size:20}),{data:ee,refetch:ae,fetchNextPage:te,isFetching:le}=(se=Z,R({queryKey:[V.getPlaylistList.name,se],queryFn:async a=>{const t=await V.getPlaylistList({...a.queryKey[1],page:a.pageParam});return 0!=t.code?(e.warning(t.msg||"请求失败"),{total:0,rows:[]}):{total:t.data.total,rows:t.data.rows}},getNextPageParam:(e,a)=>{const t=K(K(se).size)??20;return e.total>=t?a.length+1:void 0},staleTime:1e4,initialPageParam:1}));var se;const ie=I(()=>ee.value?.pages.flatMap(e=>(C.value=e.total,e.rows)).filter(Boolean)),ne=[{header:"歌曲名",key:"song_name",width:50},{header:"歌手",key:"singer",width:50},{header:"语种",key:"language",width:25},{header:"标签",key:"tag",width:50},{header:"是否SC曲目",key:"is_sc",width:25},{header:"SC曲目价格",key:"sc_price",width:25}],oe=[{header:"歌曲名",key:"song_name",type:"string"},{header:"歌手",key:"singer",type:"string"},{header:"语种",key:"language",type:"string"},{header:"标签",key:"tag",type:"string"},{header:"是否SC曲目",key:"is_sc",type:"boolean"},{header:"SC曲目价格",key:"sc_price",type:"number"}],re=[{key:"song_name",dataKey:"song_name",title:"歌名",width:200},{key:"singer",dataKey:"singer",title:"歌手",width:200},{key:"language",dataKey:"language",title:"语种",width:200},{key:"tag",dataKey:"tag",title:"标签",width:200},{key:"sc_price",dataKey:"sc_price",title:"SC曲目价格",width:200},{key:"operations",title:"操作",width:200,cellRenderer:({rowData:e})=>E($,null,[E(o,{type:"success",icon:k,onClick:a=>ce(e)},{default:()=>[B("编辑")]}),E(o,{type:"default",icon:x,onClick:a=>ge([e.id])},{default:()=>[B("删除")]})])}],de=j({mutationFn:async e=>await V.deletePlaylist({data:e}),onSuccess:(a,t)=>{if(0!=a.code)e.warning(a.msg);else{const e=new Set(t),a=ee.value?.pages.flatMap(e=>e.rows).filter(a=>!e.has(a.id))??[];s.setQueryData([V.getPlaylistList.name],()=>({pages:[{total:C.value-t.length,rows:a}]}))}},onError:a=>{e.error(a.message)}}),ue=j({mutationFn:async e=>await V.importPlaylist({data:e}),onSuccess:a=>{0!=a.code?e.warning(a.msg):ae(),n.value=!1},onError:a=>{e.error(a.message)}}),ce=e=>{Y.value&&Y.value.openDialog(e)},ge=a=>{b.confirm("是否删除？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{de.mutate(a)}).catch(a=>{"string"==typeof a&&"cancel"==a||e.error(a)})},pe=e=>{ae()},me=async(a,t)=>{if(n.value=!0,!a)return void(n.value=!1);const l=a.name.split(".");if("xlsx"!=l[l.length-1])return e.warning("请上传xlsx格式的表格"),void(n.value=!1);const s=await(a.raw?.arrayBuffer()),i=await N(oe,s);i.forEach(e=>{e.id=0,e.create_time=J()}),ue.mutate(i)},ye=()=>{const a={};Object.assign(a,Z),a.page=1,a.size=C.value,i.value=!0,V.getPlaylistList(a).then(a=>{if(0!=a.code)return e.warning(a.msg),void(i.value=!1);const t=a.data.rows.map(e=>({song_name:e.song_name,singer:e.singer,is_sc:e.is_sc?"是":"否",sc_price:e.sc_price,language:e.language,tag:e.tag})),l=`歌单_${J()}`;G(ne,t,l),i.value=!1}).catch(a=>{e.error(a),i.value=!1})},_e=()=>{ae()},fe=e=>{ie.value&&ie.value.length<C.value&&te()};return M(()=>{const e=.9*window.innerHeight;L.value?.$el.style.setProperty("overflow","hidden");const a=.6*e;z.value?.style.setProperty("height",`${a}px`)}),(e,a)=>{const s=l,k=t,x=g,b=r,V=c,C=m,P=w,S=h,j=y,L=Q,R=u,q=d,H=v;return D(),U(q,{class:"playlist-container"},{default:F(()=>[E(R,{class:"playlist-main"},{default:F(()=>[E(V,{class:"playlist-card"},{header:F(()=>[...a[3]||(a[3]=[O("div",{class:"card-header"},[O("span",null,"查询")],-1)])]),default:F(()=>[E(b,{model:K(Z),"label-width":"auto",inline:"",class:"inline-form"},{default:F(()=>[E(k,{label:"关键词",prop:"keyword"},{default:F(()=>[E(s,{modelValue:K(Z).keyword,"onUpdate:modelValue":a[0]||(a[0]=e=>K(Z).keyword=e),type:"text"},null,8,["modelValue"])]),_:1}),E(k,null,{default:F(()=>[E(K(o),{type:"primary",onClick:_e},{default:F(()=>[E(x,{class:"el-icon--left"},{default:F(()=>[E(K(p))]),_:1}),a[4]||(a[4]=B(" 搜索 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),E(C),O("div",W,[E(K(o),{type:"primary",onClick:a[1]||(a[1]=e=>ce())},{default:F(()=>[...a[5]||(a[5]=[B("新增歌曲",-1)])]),_:1}),E(K(o),{type:"danger",onClick:a[2]||(a[2]=e=>(()=>{const e=ie.value?.filter(e=>e.checked).map(e=>e.id);e&&ge(e)})()),disabled:0==K(ie)?.length},{default:F(()=>[...a[6]||(a[6]=[B("全部删除",-1)])]),_:1},8,["disabled"])]),T((D(),U(V,{class:"playlist-data-card",ref:"playlistDataCard"},{default:F(()=>[O("div",{class:"chat-infinite-list",ref_key:"playlistInfiniteList",ref:z},[E(S,null,{default:F(({width:e,height:a})=>[E(P,{columns:re,data:K(ie)||[],width:e,height:a,onEndReached:fe,fixed:""},null,8,["data","width","height"])]),_:1})],512)]),footer:F(()=>[O("div",A,[O("div",X,[E(j,{action:"#","auto-upload":!1,"show-file-list":!1,"on-change":me,accept:".xlsx"},{trigger:F(()=>[E(K(o),{type:"success",loading:K(n)},{default:F(()=>[a[7]||(a[7]=B(" 导入歌单 ",-1)),E(x,{class:"el-icon--right"},{default:F(()=>[E(K(_))]),_:1})]),_:1},8,["loading"])]),_:1}),E(K(o),{onClick:ye,loading:K(i)},{default:F(()=>[a[8]||(a[8]=B(" 导出歌单 ",-1)),E(x,{class:"el-icon--right"},{default:F(()=>[E(K(f))]),_:1})]),_:1},8,["loading"])])])]),_:1})),[[H,K(le)]]),E(L,{onSubmit:pe,ref_key:"addPlaylistDialogRef",ref:Y},null,512)]),_:1})]),_:1})}}});export{Y as default};
